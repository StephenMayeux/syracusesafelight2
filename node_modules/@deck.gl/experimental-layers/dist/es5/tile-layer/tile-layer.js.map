{"version":3,"sources":["../../../src/tile-layer/tile-layer.js"],"names":["defaultProps","renderSubLayers","props","GeoJsonLayer","getTileData","x","y","z","Promise","resolve","maxZoom","minZoom","maxCacheSize","TileLayer","state","tiles","tileCache","TileCache","isLoaded","changeFlags","somethingChanged","oldProps","context","updateTriggersChanged","all","finalize","setState","maxSize","viewportChanged","viewport","getLayerZoomLevel","id","update","currTiles","filter","tile","allCurrTilesLoaded","every","map","data","then","info","sourceLayer","Math","floor","zoom","parseInt","geoProps","visible","CompositeLayer","layerName"],"mappings":"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","sourcesContent":["import {GeoJsonLayer, CompositeLayer} from 'deck.gl';\nimport TileCache from './utils/tile-cache';\n\nconst defaultProps = {\n  renderSubLayers: props => new GeoJsonLayer(props),\n  getTileData: ({x, y, z}) => Promise.resolve(null),\n  maxZoom: null,\n  minZoom: null,\n  maxCacheSize: null\n};\n\nexport default class TileLayer extends CompositeLayer {\n  initializeState() {\n    const {maxZoom, minZoom, getTileData} = this.props;\n    this.state = {\n      tiles: [],\n      tileCache: new TileCache({getTileData, maxZoom, minZoom}),\n      isLoaded: false\n    };\n  }\n\n  shouldUpdateState({changeFlags}) {\n    return changeFlags.somethingChanged;\n  }\n\n  updateState({props, oldProps, context, changeFlags}) {\n    if (\n      changeFlags.updateTriggersChanged &&\n      (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getTileData)\n    ) {\n      const {getTileData, maxZoom, minZoom, maxCacheSize} = props;\n      this.state.tileCache.finalize();\n      this.setState({\n        tileCache: new TileCache({getTileData, maxSize: maxCacheSize, maxZoom, minZoom})\n      });\n    }\n    if (changeFlags.viewportChanged) {\n      const {viewport} = context;\n      const z = this.getLayerZoomLevel();\n      if (viewport.id !== 'DEFAULT-INITIAL-VIEWPORT') {\n        this.state.tileCache.update(viewport, tiles => {\n          const currTiles = tiles.filter(tile => tile.z === z);\n          const allCurrTilesLoaded = currTiles.every(tile => tile.isLoaded);\n          this.setState({tiles, isLoaded: allCurrTilesLoaded});\n          if (!allCurrTilesLoaded) {\n            Promise.all(currTiles.map(tile => tile.data)).then(() =>\n              this.setState({isLoaded: true})\n            );\n          }\n        });\n      }\n    }\n  }\n\n  getPickingInfo({info, sourceLayer}) {\n    info.sourceLayer = sourceLayer;\n    info.tile = sourceLayer.props.tile;\n    return info;\n  }\n\n  getLayerZoomLevel() {\n    const z = Math.floor(this.context.viewport.zoom);\n    const {maxZoom, minZoom} = this.props;\n    if (maxZoom && parseInt(maxZoom, 10) === maxZoom && z > maxZoom) {\n      return maxZoom;\n    } else if (minZoom && parseInt(minZoom, 10) === minZoom && z < minZoom) {\n      return minZoom;\n    }\n    return z;\n  }\n\n  renderLayers() {\n    // eslint-disable-next-line no-unused-vars\n    const {getTileData, renderSubLayers, ...geoProps} = this.props;\n    const z = this.getLayerZoomLevel();\n    return this.state.tiles.map(tile => {\n      return renderSubLayers({\n        ...geoProps,\n        id: `${this.id}-${tile.x}-${tile.y}-${tile.z}`,\n        data: tile.data,\n        visible: !this.state.isLoaded || tile.z === z,\n        tile\n      });\n    });\n  }\n}\n\nTileLayer.layerName = 'TileLayer';\nTileLayer.defaultProps = defaultProps;\n"],"file":"tile-layer.js"}