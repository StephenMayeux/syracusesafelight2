{"version":3,"sources":["../../../src/bitmap-layer/bitmap-layer.js"],"names":["Layer","GL","Model","Geometry","loadTextures","BITMAP_VERTEX_SHADER","BITMAP_FRAGMENT_SHADER","MAX_BITMAPS","defaultProps","images","desaturate","blendMode","transparentColor","tintColor","getCenter","x","center","getRotation","rotation","BitmapLayer","initializeState","gl","context","setState","model","getModel","attributeManager","state","addInstanced","instanceCenter","size","update","calculateInstanceCenters","instanceRotation","calculateInstanceRotations","instanceBitmapIndex","calculateInstanceBitmapIndex","updateState","props","oldProps","changed","length","i","loadMapImagesToTextures","setUniforms","verts","positions","texCoords","forEach","vertex","push","id","vs","fs","shaderCache","geometry","drawMode","TRIANGLES","vertexCount","attributes","Float32Array","isInstanced","draw","uniforms","render","Object","assign","Math","min","urls","then","texture","getBitmapIndex","point","url","imageUrl","idx","max","indexOf","attribute","data","value","bitmapIndex","Number","isFinite","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer} from '@deck.gl/core';\nimport GL from 'luma.gl/constants';\nimport {Model, Geometry, loadTextures} from 'luma.gl';\n\nimport BITMAP_VERTEX_SHADER from './bitmap-layer-vertex';\nimport BITMAP_FRAGMENT_SHADER from './bitmap-layer-fragment';\n\n// Note: needs to match vertex shader\nconst MAX_BITMAPS = 11;\n\nconst defaultProps = {\n  images: [],\n\n  desaturate: 0,\n  blendMode: null,\n  // More context: because of the blending mode we're using for ground imagery,\n  // alpha is not effective when blending the bitmap layers with the base map.\n  // Instead we need to manually dim/blend rgb values with a background color.\n  transparentColor: [0, 0, 0, 0],\n  tintColor: [255, 255, 255],\n  // accessors\n  getCenter: x => x.center,\n  getRotation: x => x.rotation\n};\n\n/*\n * @class\n * @param {object} props\n * @param {number} props.transparentColor - color to interpret transparency to\n * @param {number} props.tintColor - color bias\n */\nexport default class BitmapLayer extends Layer {\n  initializeState() {\n    const {gl} = this.context;\n    this.setState({model: this.getModel(gl)});\n\n    const {attributeManager} = this.state;\n    attributeManager.addInstanced({\n      instanceCenter: {size: 3, update: this.calculateInstanceCenters},\n      instanceRotation: {size: 3, update: this.calculateInstanceRotations},\n      instanceBitmapIndex: {size: 1, update: this.calculateInstanceBitmapIndex}\n    });\n  }\n\n  updateState({props, oldProps}) {\n    if (props.images !== oldProps.images) {\n      let changed = !oldProps.images || props.images.length !== oldProps.images.length;\n      if (!changed) {\n        for (let i = 0; i < props.images.length; ++i) {\n          changed = changed || props.images[i] !== oldProps.images[i];\n        }\n      }\n      if (changed) {\n        this.loadMapImagesToTextures();\n      }\n    }\n    const {desaturate} = props;\n    this.state.model.setUniforms({desaturate});\n  }\n\n  getModel(gl) {\n    // Two triangles making up a square to render the bitmap texture on\n    const verts = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0]];\n    const positions = [];\n    const texCoords = [];\n    verts.forEach(vertex => {\n      // geometry: unit square centered on origin\n      positions.push(vertex[0] / 2, vertex[1] / 2, vertex[2] / 2);\n      // texture: unit square with bottom left in origin\n      texCoords.push(vertex[0] / 2 + 0.5, -vertex[1] / 2 + 0.5);\n    });\n\n    const model = new Model(gl, {\n      id: this.props.id,\n      vs: BITMAP_VERTEX_SHADER,\n      fs: BITMAP_FRAGMENT_SHADER,\n      shaderCache: this.context.shaderCache,\n      geometry: new Geometry({\n        drawMode: GL.TRIANGLES,\n        vertexCount: 6,\n        attributes: {\n          positions: new Float32Array(positions),\n          texCoords: new Float32Array(texCoords)\n        }\n      }),\n      isInstanced: true\n    });\n\n    return model;\n  }\n\n  draw({uniforms}) {\n    const {transparentColor, tintColor} = this.props;\n\n    // TODO fix zFighting\n\n    // Render the image\n    this.state.model.render(\n      Object.assign({}, uniforms, {\n        transparentColor,\n        tintColor\n      })\n    );\n  }\n\n  loadMapImagesToTextures() {\n    const {model} = this.state;\n    const {images} = this.props;\n    for (let i = 0; i < Math.min(images.length, MAX_BITMAPS); i++) {\n      loadTextures(this.context.gl, {\n        urls: [images[i]]\n      }).then(([texture]) => {\n        return model.setUniforms({[`uBitmap${i}`]: texture});\n      });\n    }\n  }\n\n  getBitmapIndex(point) {\n    const url = point.imageUrl;\n    const idx = Math.max(this.props.images.indexOf(url), 0);\n    return idx >= MAX_BITMAPS ? 0 : idx;\n  }\n\n  calculateInstanceCenters(attribute, props) {\n    const {data, getCenter} = this.props;\n    const {value, size} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const center = getCenter(point);\n\n      value[i + 0] = center[0] || 0;\n      value[i + 1] = center[1] || 0;\n      value[i + 2] = center[2] || 0;\n\n      i += size;\n    }\n  }\n\n  calculateInstanceRotations(attribute, props) {\n    const {data, getRotation} = this.props;\n    const {value, size} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const rotation = getRotation(point);\n\n      value[i + 0] = rotation[0] || 0;\n      value[i + 1] = rotation[1] || 0;\n      value[i + 2] = rotation[2] || 0;\n\n      i += size;\n    }\n  }\n\n  calculateInstanceBitmapIndex(attribute) {\n    const {data} = this.props;\n    const {value, size} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const bitmapIndex = Number.isFinite(point.bitmapIndex)\n        ? point.bitmapIndex\n        : this.getBitmapIndex(point);\n      value[i] = bitmapIndex;\n      i += size;\n    }\n  }\n}\n\nBitmapLayer.layerName = 'BitmapLayer';\nBitmapLayer.defaultProps = defaultProps;\n"],"file":"bitmap-layer.js"}