{"version":3,"sources":["../../../src/bitmap-layer/bitmap-layer.js"],"names":["Layer","GL","Model","Geometry","loadTextures","BITMAP_VERTEX_SHADER","BITMAP_FRAGMENT_SHADER","MAX_BITMAPS","defaultProps","images","desaturate","blendMode","transparentColor","tintColor","getCenter","x","center","getRotation","rotation","BitmapLayer","gl","context","setState","model","getModel","attributeManager","state","addInstanced","instanceCenter","size","update","calculateInstanceCenters","instanceRotation","calculateInstanceRotations","instanceBitmapIndex","calculateInstanceBitmapIndex","props","oldProps","changed","length","i","loadMapImagesToTextures","setUniforms","verts","positions","texCoords","forEach","vertex","push","id","vs","fs","shaderCache","geometry","drawMode","TRIANGLES","vertexCount","attributes","Float32Array","isInstanced","uniforms","render","Object","assign","urls","then","texture","Math","min","point","url","imageUrl","idx","max","indexOf","attribute","data","value","bitmapIndex","Number","isFinite","getBitmapIndex","layerName"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,SAAQA,KAAR,QAAoB,eAApB;AACA,OAAOC,EAAP,MAAe,mBAAf;AACA,SAAQC,KAAR,EAAeC,QAAf,EAAyBC,YAAzB,QAA4C,SAA5C;AAEA,OAAOC,oBAAP,MAAiC,uBAAjC;AACA,OAAOC,sBAAP,MAAmC,yBAAnC,C,CAEA;;AACA,IAAMC,WAAW,GAAG,EAApB;AAEA,IAAMC,YAAY,GAAG;AACnBC,EAAAA,MAAM,EAAE,EADW;AAGnBC,EAAAA,UAAU,EAAE,CAHO;AAInBC,EAAAA,SAAS,EAAE,IAJQ;AAKnB;AACA;AACA;AACAC,EAAAA,gBAAgB,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV,CARC;AASnBC,EAAAA,SAAS,EAAE,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CATQ;AAUnB;AACAC,EAAAA,SAAS,EAAE,mBAAAC,CAAC;AAAA,WAAIA,CAAC,CAACC,MAAN;AAAA,GAXO;AAYnBC,EAAAA,WAAW,EAAE,qBAAAF,CAAC;AAAA,WAAIA,CAAC,CAACG,QAAN;AAAA;AAZK,CAArB;AAeA;;;;;;;IAMqBC,W;;;;;;;;;;;;;sCACD;AAAA,UACTC,EADS,GACH,KAAKC,OADF,CACTD,EADS;AAEhB,WAAKE,QAAL,CAAc;AAACC,QAAAA,KAAK,EAAE,KAAKC,QAAL,CAAcJ,EAAd;AAAR,OAAd;AAFgB,UAITK,gBAJS,GAIW,KAAKC,KAJhB,CAITD,gBAJS;AAKhBA,MAAAA,gBAAgB,CAACE,YAAjB,CAA8B;AAC5BC,QAAAA,cAAc,EAAE;AAACC,UAAAA,IAAI,EAAE,CAAP;AAAUC,UAAAA,MAAM,EAAE,KAAKC;AAAvB,SADY;AAE5BC,QAAAA,gBAAgB,EAAE;AAACH,UAAAA,IAAI,EAAE,CAAP;AAAUC,UAAAA,MAAM,EAAE,KAAKG;AAAvB,SAFU;AAG5BC,QAAAA,mBAAmB,EAAE;AAACL,UAAAA,IAAI,EAAE,CAAP;AAAUC,UAAAA,MAAM,EAAE,KAAKK;AAAvB;AAHO,OAA9B;AAKD;;;sCAE8B;AAAA,UAAlBC,KAAkB,QAAlBA,KAAkB;AAAA,UAAXC,QAAW,QAAXA,QAAW;;AAC7B,UAAID,KAAK,CAAC3B,MAAN,KAAiB4B,QAAQ,CAAC5B,MAA9B,EAAsC;AACpC,YAAI6B,OAAO,GAAG,CAACD,QAAQ,CAAC5B,MAAV,IAAoB2B,KAAK,CAAC3B,MAAN,CAAa8B,MAAb,KAAwBF,QAAQ,CAAC5B,MAAT,CAAgB8B,MAA1E;;AACA,YAAI,CAACD,OAAL,EAAc;AACZ,eAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,KAAK,CAAC3B,MAAN,CAAa8B,MAAjC,EAAyC,EAAEC,CAA3C,EAA8C;AAC5CF,YAAAA,OAAO,GAAGA,OAAO,IAAIF,KAAK,CAAC3B,MAAN,CAAa+B,CAAb,MAAoBH,QAAQ,CAAC5B,MAAT,CAAgB+B,CAAhB,CAAzC;AACD;AACF;;AACD,YAAIF,OAAJ,EAAa;AACX,eAAKG,uBAAL;AACD;AACF;;AAX4B,UAYtB/B,UAZsB,GAYR0B,KAZQ,CAYtB1B,UAZsB;AAa7B,WAAKgB,KAAL,CAAWH,KAAX,CAAiBmB,WAAjB,CAA6B;AAAChC,QAAAA,UAAU,EAAVA;AAAD,OAA7B;AACD;;;6BAEQU,E,EAAI;AACX;AACA,UAAMuB,KAAK,GAAG,CAAC,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAD,EAAY,CAAC,CAAC,CAAF,EAAK,CAAL,EAAQ,CAAR,CAAZ,EAAwB,CAAC,CAAD,EAAI,CAAC,CAAL,EAAQ,CAAR,CAAxB,EAAoC,CAAC,CAAC,CAAF,EAAK,CAAL,EAAQ,CAAR,CAApC,EAAgD,CAAC,CAAD,EAAI,CAAC,CAAL,EAAQ,CAAR,CAAhD,EAA4D,CAAC,CAAC,CAAF,EAAK,CAAC,CAAN,EAAS,CAAT,CAA5D,CAAd;AACA,UAAMC,SAAS,GAAG,EAAlB;AACA,UAAMC,SAAS,GAAG,EAAlB;AACAF,MAAAA,KAAK,CAACG,OAAN,CAAc,UAAAC,MAAM,EAAI;AACtB;AACAH,QAAAA,SAAS,CAACI,IAAV,CAAeD,MAAM,CAAC,CAAD,CAAN,GAAY,CAA3B,EAA8BA,MAAM,CAAC,CAAD,CAAN,GAAY,CAA1C,EAA6CA,MAAM,CAAC,CAAD,CAAN,GAAY,CAAzD,EAFsB,CAGtB;;AACAF,QAAAA,SAAS,CAACG,IAAV,CAAeD,MAAM,CAAC,CAAD,CAAN,GAAY,CAAZ,GAAgB,GAA/B,EAAoC,CAACA,MAAM,CAAC,CAAD,CAAP,GAAa,CAAb,GAAiB,GAArD;AACD,OALD;AAOA,UAAMxB,KAAK,GAAG,IAAIrB,KAAJ,CAAUkB,EAAV,EAAc;AAC1B6B,QAAAA,EAAE,EAAE,KAAKb,KAAL,CAAWa,EADW;AAE1BC,QAAAA,EAAE,EAAE7C,oBAFsB;AAG1B8C,QAAAA,EAAE,EAAE7C,sBAHsB;AAI1B8C,QAAAA,WAAW,EAAE,KAAK/B,OAAL,CAAa+B,WAJA;AAK1BC,QAAAA,QAAQ,EAAE,IAAIlD,QAAJ,CAAa;AACrBmD,UAAAA,QAAQ,EAAErD,EAAE,CAACsD,SADQ;AAErBC,UAAAA,WAAW,EAAE,CAFQ;AAGrBC,UAAAA,UAAU,EAAE;AACVb,YAAAA,SAAS,EAAE,IAAIc,YAAJ,CAAiBd,SAAjB,CADD;AAEVC,YAAAA,SAAS,EAAE,IAAIa,YAAJ,CAAiBb,SAAjB;AAFD;AAHS,SAAb,CALgB;AAa1Bc,QAAAA,WAAW,EAAE;AAba,OAAd,CAAd;AAgBA,aAAOpC,KAAP;AACD;;;gCAEgB;AAAA,UAAXqC,QAAW,SAAXA,QAAW;AAAA,wBACuB,KAAKxB,KAD5B;AAAA,UACRxB,gBADQ,eACRA,gBADQ;AAAA,UACUC,SADV,eACUA,SADV,EAGf;AAEA;;AACA,WAAKa,KAAL,CAAWH,KAAX,CAAiBsC,MAAjB,CACEC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBH,QAAlB,EAA4B;AAC1BhD,QAAAA,gBAAgB,EAAhBA,gBAD0B;AAE1BC,QAAAA,SAAS,EAATA;AAF0B,OAA5B,CADF;AAMD;;;8CAEyB;AAAA;;AAAA,UACjBU,KADiB,GACR,KAAKG,KADG,CACjBH,KADiB;AAAA,UAEjBd,MAFiB,GAEP,KAAK2B,KAFE,CAEjB3B,MAFiB;;AAAA,iCAGf+B,CAHe;AAItBpC,QAAAA,YAAY,CAAC,KAAI,CAACiB,OAAL,CAAaD,EAAd,EAAkB;AAC5B4C,UAAAA,IAAI,EAAE,CAACvD,MAAM,CAAC+B,CAAD,CAAP;AADsB,SAAlB,CAAZ,CAEGyB,IAFH,CAEQ,iBAAe;AAAA;AAAA,cAAbC,OAAa;;AACrB,iBAAO3C,KAAK,CAACmB,WAAN,sCAA8BF,CAA9B,GAAoC0B,OAApC,EAAP;AACD,SAJD;AAJsB;;AAGxB,WAAK,IAAI1B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG2B,IAAI,CAACC,GAAL,CAAS3D,MAAM,CAAC8B,MAAhB,EAAwBhC,WAAxB,CAApB,EAA0DiC,CAAC,EAA3D,EAA+D;AAAA,cAAtDA,CAAsD;AAM9D;AACF;;;mCAEc6B,K,EAAO;AACpB,UAAMC,GAAG,GAAGD,KAAK,CAACE,QAAlB;AACA,UAAMC,GAAG,GAAGL,IAAI,CAACM,GAAL,CAAS,KAAKrC,KAAL,CAAW3B,MAAX,CAAkBiE,OAAlB,CAA0BJ,GAA1B,CAAT,EAAyC,CAAzC,CAAZ;AACA,aAAOE,GAAG,IAAIjE,WAAP,GAAqB,CAArB,GAAyBiE,GAAhC;AACD;;;6CAEwBG,S,EAAWvC,K,EAAO;AAAA,yBACf,KAAKA,KADU;AAAA,UAClCwC,IADkC,gBAClCA,IADkC;AAAA,UAC5B9D,SAD4B,gBAC5BA,SAD4B;AAAA,UAElC+D,KAFkC,GAEnBF,SAFmB,CAElCE,KAFkC;AAAA,UAE3BhD,IAF2B,GAEnB8C,SAFmB,CAE3B9C,IAF2B;AAGzC,UAAIW,CAAC,GAAG,CAAR;AAHyC;AAAA;AAAA;;AAAA;AAIzC,6BAAoBoC,IAApB,8HAA0B;AAAA,cAAfP,KAAe;AACxB,cAAMrD,MAAM,GAAGF,SAAS,CAACuD,KAAD,CAAxB;AAEAQ,UAAAA,KAAK,CAACrC,CAAC,GAAG,CAAL,CAAL,GAAexB,MAAM,CAAC,CAAD,CAAN,IAAa,CAA5B;AACA6D,UAAAA,KAAK,CAACrC,CAAC,GAAG,CAAL,CAAL,GAAexB,MAAM,CAAC,CAAD,CAAN,IAAa,CAA5B;AACA6D,UAAAA,KAAK,CAACrC,CAAC,GAAG,CAAL,CAAL,GAAexB,MAAM,CAAC,CAAD,CAAN,IAAa,CAA5B;AAEAwB,UAAAA,CAAC,IAAIX,IAAL;AACD;AAZwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAa1C;;;+CAE0B8C,S,EAAWvC,K,EAAO;AAAA,yBACf,KAAKA,KADU;AAAA,UACpCwC,IADoC,gBACpCA,IADoC;AAAA,UAC9B3D,WAD8B,gBAC9BA,WAD8B;AAAA,UAEpC4D,KAFoC,GAErBF,SAFqB,CAEpCE,KAFoC;AAAA,UAE7BhD,IAF6B,GAErB8C,SAFqB,CAE7B9C,IAF6B;AAG3C,UAAIW,CAAC,GAAG,CAAR;AAH2C;AAAA;AAAA;;AAAA;AAI3C,8BAAoBoC,IAApB,mIAA0B;AAAA,cAAfP,KAAe;AACxB,cAAMnD,QAAQ,GAAGD,WAAW,CAACoD,KAAD,CAA5B;AAEAQ,UAAAA,KAAK,CAACrC,CAAC,GAAG,CAAL,CAAL,GAAetB,QAAQ,CAAC,CAAD,CAAR,IAAe,CAA9B;AACA2D,UAAAA,KAAK,CAACrC,CAAC,GAAG,CAAL,CAAL,GAAetB,QAAQ,CAAC,CAAD,CAAR,IAAe,CAA9B;AACA2D,UAAAA,KAAK,CAACrC,CAAC,GAAG,CAAL,CAAL,GAAetB,QAAQ,CAAC,CAAD,CAAR,IAAe,CAA9B;AAEAsB,UAAAA,CAAC,IAAIX,IAAL;AACD;AAZ0C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAa5C;;;iDAE4B8C,S,EAAW;AAAA,UAC/BC,IAD+B,GACvB,KAAKxC,KADkB,CAC/BwC,IAD+B;AAAA,UAE/BC,KAF+B,GAEhBF,SAFgB,CAE/BE,KAF+B;AAAA,UAExBhD,IAFwB,GAEhB8C,SAFgB,CAExB9C,IAFwB;AAGtC,UAAIW,CAAC,GAAG,CAAR;AAHsC;AAAA;AAAA;;AAAA;AAItC,8BAAoBoC,IAApB,mIAA0B;AAAA,cAAfP,KAAe;AACxB,cAAMS,WAAW,GAAGC,MAAM,CAACC,QAAP,CAAgBX,KAAK,CAACS,WAAtB,IAChBT,KAAK,CAACS,WADU,GAEhB,KAAKG,cAAL,CAAoBZ,KAApB,CAFJ;AAGAQ,UAAAA,KAAK,CAACrC,CAAD,CAAL,GAAWsC,WAAX;AACAtC,UAAAA,CAAC,IAAIX,IAAL;AACD;AAVqC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWvC;;;;EArIsC7B,K;;SAApBmB,W;AAwIrBA,WAAW,CAAC+D,SAAZ,GAAwB,aAAxB;AACA/D,WAAW,CAACX,YAAZ,GAA2BA,YAA3B","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer} from '@deck.gl/core';\nimport GL from 'luma.gl/constants';\nimport {Model, Geometry, loadTextures} from 'luma.gl';\n\nimport BITMAP_VERTEX_SHADER from './bitmap-layer-vertex';\nimport BITMAP_FRAGMENT_SHADER from './bitmap-layer-fragment';\n\n// Note: needs to match vertex shader\nconst MAX_BITMAPS = 11;\n\nconst defaultProps = {\n  images: [],\n\n  desaturate: 0,\n  blendMode: null,\n  // More context: because of the blending mode we're using for ground imagery,\n  // alpha is not effective when blending the bitmap layers with the base map.\n  // Instead we need to manually dim/blend rgb values with a background color.\n  transparentColor: [0, 0, 0, 0],\n  tintColor: [255, 255, 255],\n  // accessors\n  getCenter: x => x.center,\n  getRotation: x => x.rotation\n};\n\n/*\n * @class\n * @param {object} props\n * @param {number} props.transparentColor - color to interpret transparency to\n * @param {number} props.tintColor - color bias\n */\nexport default class BitmapLayer extends Layer {\n  initializeState() {\n    const {gl} = this.context;\n    this.setState({model: this.getModel(gl)});\n\n    const {attributeManager} = this.state;\n    attributeManager.addInstanced({\n      instanceCenter: {size: 3, update: this.calculateInstanceCenters},\n      instanceRotation: {size: 3, update: this.calculateInstanceRotations},\n      instanceBitmapIndex: {size: 1, update: this.calculateInstanceBitmapIndex}\n    });\n  }\n\n  updateState({props, oldProps}) {\n    if (props.images !== oldProps.images) {\n      let changed = !oldProps.images || props.images.length !== oldProps.images.length;\n      if (!changed) {\n        for (let i = 0; i < props.images.length; ++i) {\n          changed = changed || props.images[i] !== oldProps.images[i];\n        }\n      }\n      if (changed) {\n        this.loadMapImagesToTextures();\n      }\n    }\n    const {desaturate} = props;\n    this.state.model.setUniforms({desaturate});\n  }\n\n  getModel(gl) {\n    // Two triangles making up a square to render the bitmap texture on\n    const verts = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0]];\n    const positions = [];\n    const texCoords = [];\n    verts.forEach(vertex => {\n      // geometry: unit square centered on origin\n      positions.push(vertex[0] / 2, vertex[1] / 2, vertex[2] / 2);\n      // texture: unit square with bottom left in origin\n      texCoords.push(vertex[0] / 2 + 0.5, -vertex[1] / 2 + 0.5);\n    });\n\n    const model = new Model(gl, {\n      id: this.props.id,\n      vs: BITMAP_VERTEX_SHADER,\n      fs: BITMAP_FRAGMENT_SHADER,\n      shaderCache: this.context.shaderCache,\n      geometry: new Geometry({\n        drawMode: GL.TRIANGLES,\n        vertexCount: 6,\n        attributes: {\n          positions: new Float32Array(positions),\n          texCoords: new Float32Array(texCoords)\n        }\n      }),\n      isInstanced: true\n    });\n\n    return model;\n  }\n\n  draw({uniforms}) {\n    const {transparentColor, tintColor} = this.props;\n\n    // TODO fix zFighting\n\n    // Render the image\n    this.state.model.render(\n      Object.assign({}, uniforms, {\n        transparentColor,\n        tintColor\n      })\n    );\n  }\n\n  loadMapImagesToTextures() {\n    const {model} = this.state;\n    const {images} = this.props;\n    for (let i = 0; i < Math.min(images.length, MAX_BITMAPS); i++) {\n      loadTextures(this.context.gl, {\n        urls: [images[i]]\n      }).then(([texture]) => {\n        return model.setUniforms({[`uBitmap${i}`]: texture});\n      });\n    }\n  }\n\n  getBitmapIndex(point) {\n    const url = point.imageUrl;\n    const idx = Math.max(this.props.images.indexOf(url), 0);\n    return idx >= MAX_BITMAPS ? 0 : idx;\n  }\n\n  calculateInstanceCenters(attribute, props) {\n    const {data, getCenter} = this.props;\n    const {value, size} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const center = getCenter(point);\n\n      value[i + 0] = center[0] || 0;\n      value[i + 1] = center[1] || 0;\n      value[i + 2] = center[2] || 0;\n\n      i += size;\n    }\n  }\n\n  calculateInstanceRotations(attribute, props) {\n    const {data, getRotation} = this.props;\n    const {value, size} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const rotation = getRotation(point);\n\n      value[i + 0] = rotation[0] || 0;\n      value[i + 1] = rotation[1] || 0;\n      value[i + 2] = rotation[2] || 0;\n\n      i += size;\n    }\n  }\n\n  calculateInstanceBitmapIndex(attribute) {\n    const {data} = this.props;\n    const {value, size} = attribute;\n    let i = 0;\n    for (const point of data) {\n      const bitmapIndex = Number.isFinite(point.bitmapIndex)\n        ? point.bitmapIndex\n        : this.getBitmapIndex(point);\n      value[i] = bitmapIndex;\n      i += size;\n    }\n  }\n}\n\nBitmapLayer.layerName = 'BitmapLayer';\nBitmapLayer.defaultProps = defaultProps;\n"],"file":"bitmap-layer.js"}